<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê³ ê¸‰ í”„ë¡œì íŠ¸ ë¹„ìš© ë° ì§„ì²™ ê´€ë¦¬ ì‹œìŠ¤í…œ (Sheets ì—°ë™ ì™„ì „íŒ)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" href="logo.svg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; background:#f7f9fb;}
    .main-nav-button { transition:.2s; box-shadow:0 2px 4px rgba(0,0,0,.06); }
    .main-nav-button.active { background:#4f46e5; color:#fff; transform: translateY(-1px); }
    .table-th { background:#f8fafc; font-size:12px; letter-spacing:.02em; text-transform:uppercase; color:#64748b}
    .pill { font-size:12px; padding:.15rem .5rem; border-radius:999px; }
  </style>
</head>
<body>

  <!-- í—¤ë” -->
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <img src="logo.svg" alt="logo" class="w-8 h-8">
        <h1 class="text-xl md:text-2xl font-extrabold text-indigo-700">Project <span class="text-pink-500">Data Flow</span> Hub</h1>
      </div>
      <a href="index.html" class="text-sm text-indigo-600 hover:underline">â† íšŒì‚¬ ë©”ì¸ìœ¼ë¡œ</a>
    </div>
  </header>

  <!-- API URL ì €ì¥ -->
  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="bg-white rounded-xl shadow p-4 mb-4">
      <label class="block text-sm font-semibold text-gray-700">Apps Script ì›¹ì•± URL</label>
      <div class="flex gap-2 mt-2">
        <input id="apiBase" type="text" class="flex-1 p-2 border rounded"
               placeholder="https://script.google.com/macros/s/AKfycb.../exec">
        <button id="saveApi" class="bg-indigo-600 text-white px-4 rounded">ì£¼ì†Œ ì €ì¥</button>
      </div>
      <p class="text-xs text-gray-500 mt-1">ë°°í¬í•œ ì›¹ì•± URLì„ ì—¬ê¸° ë„£ê³  â€œì£¼ì†Œ ì €ì¥â€ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
      <div id="flash" class="text-xs mt-1"></div>
    </div>

    <!-- íƒ­ ë²„íŠ¼ -->
    <div class="grid grid-cols-2 md:grid-cols-6 gap-2 mb-4">
      <button class="main-nav-button px-3 py-2 rounded active" data-tab="dailyLog">ğŸ—“ï¸ ì¼ì¼ ê¸°ë¡ / ì…ë ¥</button>
      <button class="main-nav-button px-3 py-2 rounded" data-tab="master">âš™ï¸ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬</button>
      <button class="main-nav-button px-3 py-2 rounded" data-tab="reports">ğŸ“Š ë³´ê³ ì„œ / í˜„í™©</button>
      <button class="main-nav-button px-3 py-2 rounded" data-tab="schedule">ğŸ—“ï¸ ì¼ì • / ê°„íŠ¸</button>
      <button class="main-nav-button px-3 py-2 rounded" data-tab="help">â“ ì‚¬ìš©ë²•</button>
      <button class="main-nav-button px-3 py-2 rounded" data-tab="about">ğŸ¢ íšŒì‚¬ ì •ë³´</button>
    </div>

    <!-- ì»¨í…ì¸  -->
    <section id="view" class="bg-white rounded-xl shadow p-4"></section>
  </main>

  <!-- ê³µìš© í…œí”Œë¦¿: í‘œ í˜•íƒœ -->
  <template id="tableTemplate">
    <div>
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold" id="sheetTitle"></h2>
        <div class="flex gap-2">
          <button id="reloadBtn" class="text-sm bg-gray-100 px-3 py-1 rounded border">ìƒˆë¡œê³ ì¹¨</button>
          <button id="addBtn" class="text-sm bg-indigo-600 text-white px-3 py-1 rounded">ìƒˆë¡œ ì¶”ê°€</button>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="dataTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </template>

  <script>
    /***********************
     * 1) ì‹œíŠ¸ ë©”íƒ€ ì •ë³´
     ***********************/
    const SHEETS = {
      projects:   { label: "í”„ë¡œì íŠ¸", headers: ["id","name","budget","startDate","endDate","owner","description"] },
      personnel:  { label: "ì¸ì›",     headers: ["id","name","role","unitCost","contact"] },
      materials:  { label: "ìì¬",     headers: ["id","name","unit","unitPrice","supplier"] },
      outsourcing:{ label: "ì™¸ì£¼",     headers: ["id","name","serviceType","contractValue","period"] },
      costItems:  { label: "ë¹„ìš©í•­ëª©", headers: ["id","name","category","description"] },
      dailyLogs:  { label: "ì¼ì¼ê¸°ë¡", headers: ["id","projectId","logDate","type","resourceId","paymentStatus","personCount","equipmentCount","materialQuantity","paymentAmount","amount","content"] },
      schedules:  { label: "ì¼ì •",     headers: ["id","projectId","taskName","startDate","endDate","isCompleted"] },
    };

    /***********************
     * 2) ìœ í‹¸
     ***********************/
    const view   = document.getElementById('view');
    const apiInp = document.getElementById('apiBase');
    const flash  = document.getElementById('flash');

    const el = html => { const t = document.createElement('template'); t.innerHTML = html.trim(); return t.content.firstChild; };
    const money = n => (Number(n||0)).toLocaleString('ko-KR');
    const today = () => new Date().toISOString().slice(0,10);
    const uuid  = () => 'xxxxxx'.replace(/x/g, ()=>Math.floor(Math.random()*16).toString(16))+Date.now();

    function showMsg(msg, ok=true){
      flash.textContent = msg;
      flash.className = 'text-xs mt-1 ' + (ok ? 'text-green-600':'text-red-600');
      setTimeout(()=>flash.textContent='', 2000);
    }

    // API URL ì €ì¥
    apiInp.value = localStorage.getItem('SHEETS_API_URL') || '';
    document.getElementById('saveApi').onclick = () => {
      localStorage.setItem('SHEETS_API_URL', apiInp.value.trim());
      showMsg('ì €ì¥ë¨ ğŸ‘');
    };

    async function api(action, payload){
      const url = (localStorage.getItem('SHEETS_API_URL') || '').trim();
      if(!url){ alert('ë¨¼ì € ìœ„ì— ì›¹ì•± URLì„ ì €ì¥í•˜ì„¸ìš”!'); throw new Error('No API URL'); }
      const res = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action, ...payload })
      });
      const txt = await res.text();
      try{ return JSON.parse(txt); }catch{ return {error:txt}; }
    }

    /***********************
     * 3) íƒ­ ë¼ìš°íŒ…
     ***********************/
    document.querySelectorAll('.main-nav-button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.main-nav-button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const tab = btn.dataset.tab;
        if(tab==='master') renderMaster();
        if(tab==='dailyLog') renderDaily();
        if(tab==='schedule') renderSchedule();
        if(tab==='reports') renderReports();
        if(tab==='help') renderHelp();
        if(tab==='about') renderAbout();
      });
    });

    // ìµœì´ˆ: ì¼ì¼ê¸°ë¡ íƒ­
    renderDaily();

    /***********************
     * 4) ê³µìš© í…Œì´ë¸” ë Œë”ëŸ¬
     ***********************/
    async function renderTable(sheetKey, opts={}){
      const tpl = document.getElementById('tableTemplate').content.cloneNode(true);
      tpl.getElementById('sheetTitle').textContent = SHEETS[sheetKey].label;
      tpl.getElementById('reloadBtn').onclick = () => renderTable(sheetKey, opts);
      tpl.getElementById('addBtn').onclick = () => openEditor(sheetKey, null, opts);

      const thead = tpl.getElementById('dataTable').querySelector('thead');
      const tbody = tpl.getElementById('dataTable').querySelector('tbody');

      thead.innerHTML =
        `<tr>${SHEETS[sheetKey].headers.map(h=>`<th class="table-th px-3 py-2 text-left">${h}</th>`).join('')}
          <th class="table-th px-3 py-2 text-right">ì•¡ì…˜</th></tr>`;

      const rows = await api('read', { sheet: sheetKey, query: opts.query || null });
      const data = Array.isArray(rows) ? rows : [];
      tbody.innerHTML = '';
      data.forEach(obj=>{
        const tr = document.createElement('tr');
        SHEETS[sheetKey].headers.forEach(h=>{
          let val = obj[h] ?? '';
          if(h==='isCompleted') val = val ? 'âœ…' : '';
          tr.appendChild(el(`<td class="px-3 py-2 border-t">${val}</td>`));
        });
        const act = el(`<td class="px-3 py-2 border-t text-right space-x-2"></td>`);
        const eBtn = el(`<button class="text-xs px-2 py-1 bg-gray-100 rounded border">ìˆ˜ì •</button>`);
        const dBtn = el(`<button class="text-xs px-2 py-1 bg-red-600 text-white rounded">ì‚­ì œ</button>`);
        eBtn.onclick = ()=> openEditor(sheetKey, obj, opts);
        dBtn.onclick = async ()=>{
          if(confirm('ì‚­ì œí•˜ì‹œê² ì–´ìš”?')){
            await api('delete', { sheet: sheetKey, id: obj.id });
            renderTable(sheetKey, opts);
          }
        };
        act.append(eBtn, dBtn);
        tr.appendChild(act);
        tbody.appendChild(tr);
      });

      view.innerHTML = '';
      view.appendChild(tpl);
    }

    function openEditor(sheetKey, existing, opts={}){
      const headers = SHEETS[sheetKey].headers.filter(h => h!=='id');
      const wrap = el(`<div class="fixed inset-0 bg-black/40 flex items-center justify-center p-4 z-50"></div>`);
      const box  = el(`<div class="bg-white rounded-xl shadow-xl w-full max-w-xl p-4"></div>`);
      box.appendChild(el(`<h3 class="text-lg font-bold mb-3">${existing?'ìˆ˜ì •':'ìƒˆ í•­ëª© ì¶”ê°€'} â€” ${SHEETS[sheetKey].label}</h3>`));
      const form = el(`<form class="grid grid-cols-1 md:grid-cols-2 gap-3"></form>`);

      headers.forEach(h=>{
        const v = existing ? (existing[h] ?? '') : (h==='logDate' ? today() : '');
        form.appendChild(el(`<div><label class="text-xs text-gray-500">${h}</label>
            <input name="${h}" value="${v}" class="w-full border rounded px-2 py-1 mt-1"></div>`));
      });

      // ë²„íŠ¼ë“¤
      const row = el(`<div class="md:col-span-2 flex justify-end gap-2 mt-2"></div>`);
      const save= el(`<button class="bg-indigo-600 text-white px-3 py-1 rounded" type="submit">ì €ì¥</button>`);
      const cancel= el(`<button class="bg-gray-100 px-3 py-1 rounded border" type="button">ì·¨ì†Œ</button>`);
      cancel.onclick = ()=> wrap.remove();
      row.append(save, cancel); form.appendChild(row);

      form.onsubmit = async (e)=>{
        e.preventDefault();
        const data = Object.fromEntries(new FormData(form).entries());
        // boolean ì²˜ë¦¬
        if('isCompleted' in data){ data.isCompleted = (String(data.isCompleted).toLowerCase()==='true' || data.isCompleted==='1' || data.isCompleted==='âœ…'); }
        if(existing){ await api('update', { sheet: sheetKey, id: existing.id, record: data }); }
        else{ await api('create', { sheet: sheetKey, record: data }); }
        wrap.remove();
        renderTable(sheetKey, opts);
      };

      box.append(form); wrap.append(box); document.body.appendChild(wrap);
    }

    /***********************
     * 5) íƒ­: ë§ˆìŠ¤í„°
     ***********************/
    function renderMaster(){
      // ì‘ì€ íƒ­ ë²„íŠ¼
      const sub = el(`
        <div class="flex flex-wrap gap-2 mb-4">
          <button class="pill bg-indigo-50 text-indigo-700"  data-s="projects">í”„ë¡œì íŠ¸</button>
          <button class="pill bg-gray-100" data-s="personnel">ì¸ì›</button>
          <button class="pill bg-gray-100" data-s="materials">ìì¬</button>
          <button class="pill bg-gray-100" data-s="outsourcing">ì™¸ì£¼</button>
          <button class="pill bg-gray-100" data-s="costItems">ë¹„ìš©í•­ëª©</button>
        </div>
      `);
      const area = el(`<div></div>`);
      view.innerHTML = '';
      view.append(sub, area);

      sub.querySelectorAll('button').forEach(b=>{
        b.addEventListener('click', ()=>{
          sub.querySelectorAll('button').forEach(x=>x.className='pill bg-gray-100');
          b.className='pill bg-indigo-50 text-indigo-700';
          renderTable(b.dataset.s);
        });
      });
      // ê¸°ë³¸ì€ í”„ë¡œì íŠ¸ íƒ­
      renderTable('projects');
    }

    /***********************
     * 6) íƒ­: ì¼ì¼ ê¸°ë¡
     ***********************/
    async function renderDaily(){
      // í”„ë¡œì íŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (ë“œë¡­ë‹¤ìš´)
      const projects = await api('read', { sheet:'projects' });
      const projOpt = (projects||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');

      const html = `
        <div class="space-y-4">
          <h2 class="text-lg font-bold">ğŸ“… ì¼ì¼ ë°ì´í„° ì…ë ¥</h2>

          <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
            <div>
              <label class="text-xs text-gray-500">í”„ë¡œì íŠ¸</label>
              <select id="dlProject" class="w-full border rounded px-2 py-2 mt-1">
                <option value="">-- ì„ íƒ --</option>
                ${projOpt}
              </select>
            </div>
            <div>
              <label class="text-xs text-gray-500">ë‚ ì§œ</label>
              <input id="dlDate" type="date" value="${today()}" class="w-full border rounded px-2 py-2 mt-1">
            </div>
            <div class="flex items-end">
              <button id="dlReload" class="w-full bg-gray-100 border rounded px-3 py-2">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
          </div>

          <div id="dlForms" class="space-y-6"></div>
        </div>
      `;
      view.innerHTML = html;

      document.getElementById('dlReload').onclick = loadDailyForms;
      async function loadDailyForms(){
        const projectId = document.getElementById('dlProject').value;
        const logDate   = document.getElementById('dlDate').value;
        if(!projectId || !logDate){ alert('í”„ë¡œì íŠ¸ì™€ ë‚ ì§œë¥¼ ì„ íƒí•˜ì„¸ìš”.'); return; }

        // ë§ˆìŠ¤í„° ì½ê¸°
        const personnel = await api('read',{sheet:'personnel'});
        const materials = await api('read',{sheet:'materials'});
        const costItems = await api('read',{sheet:'costItems'});

        const area = document.getElementById('dlForms');
        area.innerHTML = '';

        // ì¸ì› íˆ¬ì…
        area.appendChild(el(`
          <div class="bg-white border rounded-xl p-4">
            <h3 class="font-bold mb-2">ğŸ‘· ì¸ì› íˆ¬ì…</h3>
            <div class="grid md:grid-cols-4 gap-2">
              <select id="p_sel" class="border rounded px-2 py-2">
                <option value="">ì¸ì› ì„ íƒ</option>
                ${(personnel||[]).map(p=>`<option value="${p.id}" data-cost="${p.unitCost||0}">${p.name} (${p.role||''})</option>`).join('')}
              </select>
              <input id="p_cnt" type="number" min="0" step="0.5" placeholder="ëª…ìˆ˜" class="border rounded px-2 py-2">
              <select id="p_pay" class="border rounded px-2 py-2">
                <option value="ë¯¸ì§€ê¸‰">ë¯¸ì§€ê¸‰</option>
                <option value="ì§€ê¸‰ì™„ë£Œ">ì§€ê¸‰ì™„ë£Œ</option>
              </select>
              <button id="p_save" class="bg-indigo-600 text-white rounded px-3">ì €ì¥</button>
            </div>
          </div>
        `));
        document.getElementById('p_save').onclick = async ()=>{
          const rid = document.getElementById('p_sel').value;
          const cnt = document.getElementById('p_cnt').value;
          const pay = document.getElementById('p_pay').value;
          if(!rid || !cnt) return alert('ì¸ì›ê³¼ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
          await api('create', { sheet:'dailyLogs', record:{
            projectId, logDate, type:'manpower', resourceId:rid, paymentStatus:pay, personCount:cnt
          }});
          showMsg('ì¸ì› ì €ì¥ ì™„ë£Œ');
        };

        // ìì¬ ì‚¬ìš©
        area.appendChild(el(`
          <div class="bg-white border rounded-xl p-4">
            <h3 class="font-bold mb-2">ğŸ—ï¸ ìì¬ ì‚¬ìš©</h3>
            <div class="grid md:grid-cols-4 gap-2">
              <select id="m_sel" class="border rounded px-2 py-2">
                <option value="">ìì¬ ì„ íƒ</option>
                ${(materials||[]).map(m=>`<option value="${m.id}" data-price="${m.unitPrice||0}">${m.name} (${m.unit||''})</option>`).join('')}
              </select>
              <input id="m_qty" type="number" min="0" step="0.01" placeholder="ìˆ˜ëŸ‰" class="border rounded px-2 py-2">
              <select id="m_pay" class="border rounded px-2 py-2">
                <option value="ë¯¸ì§€ê¸‰">ë¯¸ì§€ê¸‰</option>
                <option value="ì§€ê¸‰ì™„ë£Œ">ì§€ê¸‰ì™„ë£Œ</option>
              </select>
              <button id="m_save" class="bg-indigo-600 text-white rounded px-3">ì €ì¥</button>
            </div>
          </div>
        `));
        document.getElementById('m_save').onclick = async ()=>{
          const rid = document.getElementById('m_sel').value;
          const qty = document.getElementById('m_qty').value;
          const pay = document.getElementById('m_pay').value;
          if(!rid || !qty) return alert('ìì¬ì™€ ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
          await api('create', { sheet:'dailyLogs', record:{
            projectId, logDate, type:'materials', resourceId:rid, paymentStatus:pay, materialQuantity:qty
          }});
          showMsg('ìì¬ ì €ì¥ ì™„ë£Œ');
        };

        // ê¸°íƒ€ ë¹„ìš©/ìˆ˜ì…
        area.appendChild(el(`
          <div class="bg-white border rounded-xl p-4">
            <h3 class="font-bold mb-2">ğŸ’³ ê¸°íƒ€ ë¹„ìš©/ìˆ˜ì…</h3>
            <div class="grid md:grid-cols-5 gap-2">
              <select id="c_sel" class="border rounded px-2 py-2">
                <option value="">í•­ëª© ì„ íƒ</option>
                ${(costItems||[]).map(c=>`<option value="${c.id}">${c.name} (${c.category||'ê¸°íƒ€'})</option>`).join('')}
              </select>
              <input id="c_amt" type="number" min="1" step="1" placeholder="ê¸ˆì•¡(ì›)" class="border rounded px-2 py-2">
              <select id="c_type" class="border rounded px-2 py-2">
                <option value="expense">ì§€ì¶œ</option>
                <option value="income">ìˆ˜ì…</option>
              </select>
              <select id="c_pay" class="border rounded px-2 py-2">
                <option value="ë¯¸ì§€ê¸‰">ë¯¸ì§€ê¸‰</option>
                <option value="ì§€ê¸‰ì™„ë£Œ">ì§€ê¸‰ì™„ë£Œ</option>
              </select>
              <button id="c_save" class="bg-indigo-600 text-white rounded px-3">ì €ì¥</button>
            </div>
          </div>
        `));
        document.getElementById('c_save').onclick = async ()=>{
          const rid = document.getElementById('c_sel').value;
          const amt = document.getElementById('c_amt').value;
          const typ = document.getElementById('c_type').value;
          const pay = document.getElementById('c_pay').value;
          if(!rid || !amt) return alert('í•­ëª©ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”.');
          await api('create', { sheet:'dailyLogs', record:{
            projectId, logDate, type:typ, resourceId:rid, paymentStatus:pay, amount:amt
          }});
          showMsg('ê¸°íƒ€ í•­ëª© ì €ì¥ ì™„ë£Œ');
        };

        // ì‘ì—… ì¼ì§€
        area.appendChild(el(`
          <div class="bg-white border rounded-xl p-4">
            <h3 class="font-bold mb-2">ğŸ“ ì‘ì—… ì¼ì§€</h3>
            <textarea id="w_txt" rows="5" class="w-full border rounded px-2 py-2" placeholder="ì˜¤ëŠ˜ í•œ ì¼, íŠ¹ì´ì‚¬í•­ ë“±ì„ ì ì–´ì£¼ì„¸ìš”."></textarea>
            <div class="text-right mt-2">
              <button id="w_save" class="bg-orange-500 text-white rounded px-3">ì €ì¥</button>
            </div>
          </div>
        `));
        document.getElementById('w_save').onclick = async ()=>{
          const content = document.getElementById('w_txt').value.trim();
          if(!content) return alert('ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
          await api('create',{ sheet:'dailyLogs', record: { projectId, logDate, type:'worklog', content }});
          showMsg('ì‘ì—… ì¼ì§€ ì €ì¥ ì™„ë£Œ');
        };
      }
    }

    /***********************
     * 7) íƒ­: ì¼ì •/ê°„íŠ¸
     ***********************/
    async function renderSchedule(){
      const projects = await api('read', {sheet:'projects'});
      const projOpt = (projects||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      view.innerHTML = `
        <div class="space-y-4">
          <h2 class="text-lg font-bold">ğŸ—“ï¸ ì¼ì • ê´€ë¦¬</h2>
          <div class="grid md:grid-cols-5 gap-2">
            <select id="sch_proj" class="border rounded px-2 py-2"><option value="">í”„ë¡œì íŠ¸</option>${projOpt}</select>
            <input id="sch_name" placeholder="ì—…ë¬´ëª…" class="border rounded px-2 py-2">
            <input id="sch_s" type="date" value="${today()}" class="border rounded px-2 py-2">
            <input id="sch_e" type="date" value="${today()}" class="border rounded px-2 py-2">
            <button id="sch_add" class="bg-indigo-600 text-white rounded px-3">ì¼ì • ì¶”ê°€</button>
          </div>
          <div id="sch_list"></div>
        </div>
      `;
      document.getElementById('sch_add').onclick = async ()=>{
        const p = document.getElementById('sch_proj').value;
        const n = document.getElementById('sch_name').value;
        const s = document.getElementById('sch_s').value;
        const e = document.getElementById('sch_e').value;
        if(!p || !n || !s || !e) return alert('ëª¨ë‘ ì…ë ¥í•˜ì„¸ìš”.');
        if(s>e) return alert('ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ì–´ìš”.');
        await api('create', { sheet:'schedules', record:{ projectId:p, taskName:n, startDate:s, endDate:e, isCompleted:false }});
        showMsg('ì¼ì • ì¶”ê°€ ì™„ë£Œ');
        paintList();
      };
      paintList();

      async function paintList(){
        const all = await api('read', {sheet:'schedules'});
        if(!Array.isArray(all) || !all.length){ document.getElementById('sch_list').innerHTML = '<p class="text-gray-500">ë“±ë¡ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>'; return; }
        const min = new Date(Math.min(...all.map(a=>new Date(a.startDate))));
        const max = new Date(Math.max(...all.map(a=>new Date(a.endDate))));
        const days = Math.ceil((max-min)/(1000*60*60*24))+1;

        let html = `
          <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="table-th"><tr>
              <th class="px-3 py-2 text-left">ì—…ë¬´ëª…</th>
              <th class="px-3 py-2 text-left">ê¸°ê°„</th>
              <th class="px-3 py-2 text-left">ì§„ì²™</th>
              <th class="px-3 py-2 text-right">ì™„ë£Œ</th>
            </tr></thead><tbody>
        `;
        all.forEach(t=>{
          const s = new Date(t.startDate), e = new Date(t.endDate);
          const startOffset = Math.ceil((s - min)/(1000*60*60*24));
          const duration = Math.ceil((e - s)/(1000*60*60*24))+1;
          const left = (startOffset/days)*100;
          const width = (duration/days)*100;
          html += `
            <tr>
              <td class="px-3 py-2 border-t">${t.taskName}</td>
              <td class="px-3 py-2 border-t">${t.startDate} ~ ${t.endDate}</td>
              <td class="px-3 py-2 border-t">
                <div class="h-2 bg-gray-200 rounded-full relative overflow-hidden">
                  <div style="margin-left:${left}%; width:${width}%;" class="h-2 ${t.isCompleted?'bg-green-500':'bg-indigo-500'} rounded-full"></div>
                </div>
              </td>
              <td class="px-3 py-2 border-t text-right">
                <button data-id="${t.id}" class="doneBtn text-xs px-2 py-1 rounded border ${t.isCompleted?'bg-green-100':'bg-gray-100'}">${t.isCompleted?'í•´ì œ':'ì™„ë£Œ'}</button>
              </td>
            </tr>
          `;
        });
        html += `</tbody></table></div>
        <div class="text-xs text-gray-500 mt-1">ì°¨íŠ¸ ê¸°ê°„: ${min.toISOString().slice(0,10)} ~ ${max.toISOString().slice(0,10)} (ì´ ${days}ì¼)</div>`;
        const box = document.getElementById('sch_list');
        box.innerHTML = html;
        box.querySelectorAll('.doneBtn').forEach(b=>{
          b.onclick = async ()=>{
            const id = b.dataset.id;
            const task = all.find(x=>x.id===id);
            await api('update', { sheet:'schedules', id, record:{ isCompleted: !task.isCompleted }});
            paintList();
          };
        });
      }
    }

    /***********************
     * 8) íƒ­: ë³´ê³ ì„œ
     ***********************/
    async function renderReports(){
      const projects = await api('read', {sheet:'projects'});
      const projOpt = (projects||[]).map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
      view.innerHTML = `
        <div class="space-y-4">
          <h2 class="text-lg font-bold">ğŸ“Š ë³´ê³ ì„œ / ì§‘ê³„</h2>
          <div class="grid md:grid-cols-4 gap-2">
            <select id="rp_proj" class="border rounded px-2 py-2"><option value="">í”„ë¡œì íŠ¸</option>${projOpt}</select>
            <input id="rp_from" type="date" value="${today()}" class="border rounded px-2 py-2">
            <input id="rp_to" type="date" value="${today()}" class="border rounded px-2 py-2">
            <button id="rp_go" class="bg-indigo-600 text-white rounded px-3">ë³´ê¸°</button>
          </div>
          <div id="rp_out"></div>
        </div>
      `;
      document.getElementById('rp_go').onclick = async ()=>{
        const pid = document.getElementById('rp_proj').value;
        const f   = document.getElementById('rp_from').value;
        const t   = document.getElementById('rp_to').value;
        if(!pid) return alert('í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
        const logs = await api('read', { sheet:'dailyLogs' });
        const inRange = (logs||[]).filter(l=> l.projectId===pid && l.logDate>=f && l.logDate<=t);
        let totalCost=0, totalIncome=0, totalPaid=0, totalUnpaid=0;

        inRange.forEach(l=>{
          let cost=0, income=0;
          if(l.type==='income'){ income += Number(l.amount||0); }
          else if(l.type==='expense'){ cost += Number(l.amount||0); }
          else if(l.type==='materials'){ /* ë‹¨ê°€Ã—ìˆ˜ëŸ‰ì€ ë§ˆìŠ¤í„° ì—†ì´ ê°„ë‹¨í‘œ: ë³´ê³ ì„œì—ì„  ëˆ„ì  ìˆ˜ëŸ‰ë§Œ ë¹„ìš©ìœ¼ë¡œëŠ” ë¯¸ë°˜ì˜(í™•ì¥ ì—¬ì§€) */ }
          else if(l.type==='manpower'){ /* ë‹¨ê°€Ã—ëª…ìˆ˜ ê³„ì‚°ì€ ë§ˆìŠ¤í„° ë‹¨ê°€ í•„ìš” â†’ ê°„ë‹¨íŒì—ì„œëŠ” ë¯¸ë°˜ì˜ */ }

          totalCost   += cost;
          totalIncome += income;
          if(l.paymentStatus==='ì§€ê¸‰ì™„ë£Œ') totalPaid += (cost||0);
          else if(l.type!=='income') totalUnpaid += (cost||0);
        });
        const net = totalIncome - totalCost;

        document.getElementById('rp_out').innerHTML = `
          <div class="grid md:grid-cols-3 gap-4">
            <div class="p-4 rounded-xl border bg-red-50 text-red-700">
              <p class="text-sm">ì´ ë¹„ìš©</p>
              <p class="text-2xl font-extrabold">${money(totalCost)} ì›</p>
            </div>
            <div class="p-4 rounded-xl border bg-blue-50 text-blue-700">
              <p class="text-sm">ì´ ìˆ˜ì…</p>
              <p class="text-2xl font-extrabold">${money(totalIncome)} ì›</p>
            </div>
            <div class="p-4 rounded-xl border ${net>=0?'bg-green-50 text-green-700':'bg-rose-50 text-rose-700'}">
              <p class="text-sm">ìˆœì´ìµ</p>
              <p class="text-2xl font-extrabold">${money(net)} ì›</p>
            </div>
            <div class="p-4 rounded-xl border bg-amber-50 text-amber-700">
              <p class="text-sm">ë¯¸ì§€ê¸‰</p>
              <p class="text-2xl font-extrabold">${money(totalUnpaid)} ì›</p>
            </div>
            <div class="p-4 rounded-xl border bg-emerald-50 text-emerald-700">
              <p class="text-sm">ì§€ê¸‰ì™„ë£Œ</p>
              <p class="text-2xl font-extrabold">${money(totalPaid)} ì›</p>
            </div>
          </div>
          <p class="text-xs text-gray-500 mt-2">â€» ì¸ì›/ìì¬ ë‹¨ê°€ ê¸°ë°˜ ìë™ê³„ì‚°ì€ â€œê³ ê¸‰ ëª¨ë“œâ€ì—ì„œ í™•ì¥ ê°€ëŠ¥í•´ìš”.</p>
        `;
      };
    }

    /***********************
     * 9) íƒ­: ì‚¬ìš©ë²• & íšŒì‚¬
     ***********************/
    function renderHelp(){
      view.innerHTML = `
        <div class="space-y-2">
          <h2 class="text-lg font-bold">â“ ì‚¬ìš©ë²•</h2>
          <ol class="list-decimal pl-5 space-y-1 text-sm">
            <li>ìœ„ì— â€œApps Script ì›¹ì•± URLâ€ì— ì£¼ì†Œë¥¼ ì €ì¥í•˜ì„¸ìš”.</li>
            <li>â€œâš™ï¸ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬â€ íƒ­ì—ì„œ ë¨¼ì € <b>í”„ë¡œì íŠ¸</b>ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.</li>
            <li>í•„ìš”í•˜ë©´ ì¸ì›, ìì¬, ë¹„ìš©í•­ëª©ë„ ë“±ë¡í•˜ì„¸ìš”.</li>
            <li>â€œğŸ—“ï¸ ì¼ì¼ ê¸°ë¡ / ì…ë ¥â€ì—ì„œ í”„ë¡œì íŠ¸ì™€ ë‚ ì§œë¥¼ ê³ ë¥´ê³  íˆ¬ì…/ë¹„ìš©/ì¼ì§€ë¥¼ ì €ì¥í•˜ì„¸ìš”.</li>
            <li>â€œğŸ—“ï¸ ì¼ì • / ê°„íŠ¸â€ì—ì„œ ì—…ë¬´ ì¼ì •ì„ ì¶”ê°€í•˜ì„¸ìš”.</li>
            <li>â€œğŸ“Š ë³´ê³ ì„œ / í˜„í™©â€ì—ì„œ ê¸°ê°„ì„ ì •í•´ í•©ê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”.</li>
          </ol>
        </div>
      `;
    }
    function renderAbout(){
      view.innerHTML = `
        <div class="space-y-2">
          <h2 class="text-lg font-bold">ğŸ¢ íšŒì‚¬ ì •ë³´</h2>
          <p class="text-sm text-gray-600">ì£¼ì˜ê±´ì„¤ì‚°ì—… ì£¼ì‹íšŒì‚¬ â€” í† ëª© ì „ë¬¸</p>
          <img src="logo.svg" alt="logo" class="h-12 mt-2">
          <p class="text-xs text-gray-500">ì´ í˜ì´ì§€ëŠ” Google Sheetsë¥¼ ë°ì´í„°ë² ì´ìŠ¤ì²˜ëŸ¼ ì‚¬ìš©í•˜ëŠ” ê²½ëŸ‰ ê´€ë¦¬ë„êµ¬ì…ë‹ˆë‹¤.</p>
        </div>
      `;
    }
  </script>
</body>
</html>
