<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê³ ê¸‰ í”„ë¡œì íŠ¸ ë¹„ìš© ë° ì§„ì²™ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Inter', sans-serif; background-color:#f7f9fb; }
    .main-nav-button { transition: all 0.3s ease; }
    .main-nav-button.active {
      background-color:#4f46e5; color:white; transform: translateY(-2px);
    }
    .overflow-y-scroll::-webkit-scrollbar { width:8px; }
    .overflow-y-scroll::-webkit-scrollbar-track { background:#f1f1f1; }
    .overflow-y-scroll::-webkit-scrollbar-thumb { background:#bbb; border-radius:4px; }
    .overflow-y-scroll::-webkit-scrollbar-thumb:hover { background:#888; }
    @media (max-width:768px) {
      #mainLayout { flex-direction:column; }
      #sidebar { width:100%; border-right:none; border-bottom:1px solid #e5e7eb; }
      #sidebar h2 { display:none; }
      #projectList { max-height:150px; overflow-y:auto; display:flex; flex-wrap:wrap; }
      #projectList li { width:50%; padding:0.5rem; }
      #projectList li.font-semibold { background-color:#eef2ff; }
    }
  </style>
</head>
<body>

  <header class="bg-white shadow-xl sticky top-0 z-10">
    <div class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap justify-between items-center border-b border-gray-100">
      <h1 class="text-3xl font-black text-indigo-700">Project <span class="text-pink-500">Data Flow</span> Hub</h1>
      <div class="text-sm text-gray-500 hidden md:block">
        <span class="font-semibold">ì¤´ì˜ê±´ì„¤ì‚°ì—…(ì£¼)</span>
      </div>
    </div>
    <div class="flex justify-center p-3 bg-indigo-50 border-t border-indigo-100 shadow-inner">
      <button class="main-nav-button px-6 py-3 mx-1 rounded-xl text-lg font-bold active" data-tab="dailyLog">ğŸ—“ï¸ ì¼ì¼ ê¸°ë¡ / ì…ë ¥</button>
      <button class="main-nav-button px-6 py-3 mx-1 rounded-xl text-lg font-bold" data-tab="master">âš™ï¸ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬</button>
      <button class="main-nav-button px-6 py-3 mx-1 rounded-xl text-lg font-bold" data-tab="reports">ğŸ“Š ë³´ê³ ì„œ / í˜„í™©</button>
      <button class="main-nav-button px-6 py-3 mx-1 rounded-xl text-lg font-bold" data-tab="schedule">ğŸ—“ï¸ ì¼ì • / ê°„íŠ¸</button>
    </div>
  </header>

  <div id="messageBox" class="fixed top-20 right-5 z-50"></div>

  <div id="loadingIndicator" class="flex justify-center items-center h-[80vh]">
    <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-2xl">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500"></div>
      <p class="mt-4 text-xl text-indigo-600 font-bold">ì‹œìŠ¤í…œ ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë”© ì¤‘...</p>
    </div>
  </div>

  <main id="mainContent" class="hidden max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div id="mainLayout" class="flex">
      <aside id="sidebar" class="w-full md:w-64 bg-white p-0 shadow-lg md:shadow-xl rounded-xl mr-4 overflow-hidden h-fit md:h-auto sticky top-40 z-0">
        <h2 class="text-xl font-bold text-gray-700 p-4 border-b border-gray-200 bg-gray-50 hidden md:block">ğŸ› ï¸ í”„ë¡œì íŠ¸ ì„ íƒ</h2>
        <ul id="projectList" class="divide-y divide-gray-100 overflow-y-scroll max-h-[40vh] md:max-h-[70vh]"></ul>
      </aside>
      <section id="contentArea" class="flex-1 w-full bg-white p-6 md:p-8 rounded-xl shadow-xl">
        <!-- íƒ­ ë‚´ìš©ì´ ì—¬ê¸° ë Œë”ë©ë‹ˆë‹¤ -->
      </section>
    </div>
  </main>

  <script>
    /** ===== ì„¤ì • ===== **/
    const API_URL_INPUT_ID = 'apiBaseInput';  // ë§Œì•½ ì…ë ¥ì¹¸ì„ ë”°ë¡œ ë§Œë“¤ë©´ ì´ ID ì‚¬ìš©
    let API_BASE_URL = '';

    // ì‹œíŠ¸ ìŠ¤í‚¤ë§ˆ (app.html êµ¬ì¡°ì™€ ë™ì¼)
    const SHEETS = {
      projects:    { label:"í”„ë¡œì íŠ¸",     headers:["id","name","budget","startDate","endDate","owner","description"] },
      personnel:   { label:"ì¸ì›",         headers:["id","name","role","unitCost","contact"] },
      materials:   { label:"ìì¬",         headers:["id","name","unit","unitPrice","supplier"] },
      outsourcing: { label:"ì™¸ì£¼",         headers:["id","company","serviceType","contractValue","period"] },
      costs:       { label:"ë¹„ìš©",         headers:["id","projectId","date","category","item","amount","paidStatus"] },
      schedules:   { label:"ì¼ì •",         headers:["id","projectId","taskName","startDate","endDate","isCompleted"] },
    };

    let state = {
      selectedProjectId: null,
      activeTab: 'dailyLog',
      masterSubTab: 'projects',
      reportSubTab: 'daily',
      dailyLogSubTab: 'manpower',
      projects: [],
      masterData: {
        personnel: [], materials: [], outsourcing: [], costItems: []
      },
      dailyLogs: [],
      schedules: []
    };

    // ìœ í‹¸ í•¨ìˆ˜
    function showMessage(msg, isError = false) {
      const box = document.getElementById('messageBox');
      box.textContent = msg;
      box.className = `fixed top-20 right-5 z-50 p-3 rounded-xl shadow-2xl ${isError?'bg-red-600 text-white':'bg-green-600 text-white'}`;
      setTimeout(()=>{
        box.textContent = '';
        box.className = 'fixed top-20 right-5 z-50';
      }, 3000);
    }

    async function apiCall(action, payload) {
      if (!API_BASE_URL) {
        showMessage('API ì£¼ì†Œê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', true);
        throw 'API_BASE_URL empty';
      }
      const res = await fetch(API_BASE_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ action, ...payload })
      });
      const txt = await res.text();
      try { return JSON.parse(txt); } catch(e) { return { error: txt }; }
    }

    // í”„ë¡œì íŠ¸ ëª©ë¡ ë¡œë“œ
    async function loadProjects() {
      const rows = await apiCall('read', { sheet:'projects' });
      state.projects = Array.isArray(rows)?rows: [];
      renderApp();
    }

    // íƒ­ ì „í™˜
    function switchTab(tabKey) {
      state.activeTab = tabKey;
      document.querySelectorAll('.main-nav-button').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab')===tabKey);
      });
      renderApp();
    }

    document.addEventListener('DOMContentLoaded', () => {
      // API ì…ë ¥ì°½ì´ ìˆë‹¤ë©´
      const input = document.getElementById(API_URL_INPUT_ID);
      if (input) {
        input.value = localStorage.getItem('API_BASE_URL') || '';
        input.addEventListener('change', ()=>{
          localStorage.setItem('API_BASE_URL', input.value.trim());
          API_BASE_URL = input.value.trim();
          showMessage('API ì£¼ì†Œ ì €ì¥ë¨');
          loadProjects();
        });
        API_BASE_URL = input.value.trim();
      }

      document.querySelectorAll('.main-nav-button').forEach(btn=>{
        btn.addEventListener('click', ()=> switchTab(btn.getAttribute('data-tab')));
      });

      loadProjects().then(()=>{
        document.getElementById('loadingIndicator').classList.add('hidden');
        document.getElementById('mainContent').classList.remove('hidden');
      }).catch(err=>{
        showMessage('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: '+err, true);
        document.getElementById('loadingIndicator').classList.add('hidden');
      });
    });

    function renderProjectSidebar() {
      const ul = document.getElementById('projectList');
      ul.innerHTML = '';
      if (!state.projects.length) {
        ul.innerHTML = '<li class="p-4 text-sm text-gray-500">ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
      } else {
        state.projects.forEach(proj=>{
          const li = document.createElement('li');
          li.textContent = proj.name || '(ì´ë¦„ ì—†ìŒ)';
          li.className = `cursor-pointer p-3 transition duration-200 ${state.selectedProjectId===proj.id?'bg-indigo-100 font-semibold':'hover:bg-gray-50'}`;
          li.onclick = ()=> {
            state.selectedProjectId = proj.id;
            renderApp();
          };
          ul.appendChild(li);
        });
      }
    }

    function renderApp() {
      renderProjectSidebar();

      const area = document.getElementById('contentArea');
      if (state.activeTab === 'master') {
        area.innerHTML = `<p class="text-gray-500">ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬ íƒ­ ì¤€ë¹„ ì¤‘â€¦</p>`;
      } else if (state.activeTab === 'dailyLog') {
        area.innerHTML = `<p class="text-gray-500">ì¼ì¼ ê¸°ë¡ íƒ­ ì¤€ë¹„ ì¤‘â€¦</p>`;
      } else if (state.activeTab === 'schedule') {
        area.innerHTML = `<p class="text-gray-500">ì¼ì • / ê°„íŠ¸ íƒ­ ì¤€ë¹„ ì¤‘â€¦</p>`;
      } else if (state.activeTab === 'reports') {
        area.innerHTML = `<p class="text-gray-500">ë³´ê³ ì„œ / í˜„í™© íƒ­ ì¤€ë¹„ ì¤‘â€¦</p>`;
      } else {
        area.innerHTML = `<p class="text-gray-500">íƒ­ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>`;
      }
    }
  </script>

</body>
</html>
