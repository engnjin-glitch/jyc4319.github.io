<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì£¼ì˜ê±´ì„¤ì‚°ì—… í”„ë¡œì íŠ¸ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
    .main-nav-button {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                  0 2px 4px -2px rgba(0, 0, 0, 0.06);
    }
    .main-nav-button.active {
      background-color: #4f46e5;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3),
                  0 4px 6px -4px rgba(79, 70, 229, 0.3);
    }
  </style>
</head>

<body>
  <!-- í—¤ë” -->
  <header class="bg-white shadow-xl sticky top-0 z-10">
    <div class="max-w-full mx-auto px-4 py-3 flex justify-between items-center border-b border-gray-100">
      <div class="flex items-center space-x-3">
        <img src="ì£¼ì˜ë¡œê³ (ê¸€ì”¨).png" alt="ì£¼ì˜ê±´ì„¤ì‚°ì—…" class="w-10 h-auto">
        <h1 class="text-3xl font-black text-indigo-700">ì£¼ì˜ê±´ì„¤ì‚°ì—… <span class="text-pink-500">í”„ë¡œì íŠ¸ ê´€ë¦¬</span></h1>
      </div>
      <div class="text-sm text-gray-500">
        <span class="font-semibold">User ID:</span>
        <span id="userIdDisplay" class="truncate font-mono text-xs">ì—°ê²° ì¤‘...</span>
      </div>
    </div>

    <!-- ë„¤ë¹„ê²Œì´ì…˜ -->
    <div class="flex justify-center p-3 bg-indigo-50 border-t border-indigo-100 shadow-inner">
      <button class="main-nav-button px-6 py-3 mx-1 rounded-xl text-lg font-bold active" data-tab="dailyLog">ğŸ—“ï¸ ì¼ì¼ ê¸°ë¡ / ì…ë ¥</button>
      <button class="main-nav-button px-6 py-3 mx-1 rounded-xl text-lg font-bold" data-tab="master">âš™ï¸ ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬</button>
      <button class="main-nav-button px-6 py-3 mx-1 rounded-xl text-lg font-bold" data-tab="reports">ğŸ“Š ë³´ê³ ì„œ / í˜„í™©</button>
      <button class="main-nav-button px-6 py-3 mx-1 rounded-xl text-lg font-bold" data-tab="schedule">ğŸ—“ï¸ ì¼ì • / ê°„íŠ¸</button>
    </div>
  </header>

  <!-- ë©”ì‹œì§€ -->
  <div id="messageBox" class="fixed top-20 right-5 z-50"></div>

  <!-- ë¡œë”© í™”ë©´ -->
  <div id="loadingIndicator" class="flex justify-center items-center h-[80vh]">
    <div class="flex flex-col items-center p-8 bg-white rounded-xl shadow-2xl">
      <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500"></div>
      <p class="mt-4 text-xl text-indigo-600 font-bold">ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>
  </div>

  <!-- ë©”ì¸ ì½˜í…ì¸  -->
  <main id="mainContent" class="hidden max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
    <div class="flex">
      <!-- ì™¼ìª½ ì‚¬ì´ë“œë°” -->
      <aside id="sidebar" class="w-full md:w-64 bg-white rounded-xl shadow-md mr-4">
        <h2 class="text-lg font-bold text-gray-700 p-4 border-b border-gray-200 bg-gray-50">ğŸ› ï¸ í”„ë¡œì íŠ¸ ì„ íƒ</h2>
        <ul id="projectList" class="divide-y divide-gray-100 overflow-y-scroll max-h-[60vh]"></ul>
      </aside>

      <!-- ì˜¤ë¥¸ìª½ ë³¸ë¬¸ -->
      <section id="contentArea" class="flex-1 bg-white p-6 rounded-xl shadow-xl">
        <div class="p-8 text-center text-gray-500">íƒ­ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</div>
      </section>
    </div>
  </main>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // 1) ë¡œë”© ìˆ¨ê¸°ê³  ë³¸ë¬¸ ë³´ì´ê¸°
    const loading = document.getElementById('loadingIndicator');
    const main = document.getElementById('mainContent');
    if (loading) loading.classList.add('hidden');
    if (main) main.classList.remove('hidden');

    // 2) íƒ­ ë²„íŠ¼ active í† ê¸€ (í˜„ì¬ëŠ” ìŠ¤íƒ€ì¼ë§Œ ë°˜ì‘)
    const buttons = document.querySelectorAll('.main-nav-button');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // ì•„ì§ ë°ì´í„° ì—°ë™ ì „ì´ë¯€ë¡œ ì•ˆë‚´ë§Œ í‘œì‹œ
        const tab = btn.getAttribute('data-tab');
        const content = document.getElementById('contentArea');
        if (content) {
          const label =
            tab === 'dailyLog' ? 'ì¼ì¼ ê¸°ë¡ / ì…ë ¥' :
            tab === 'master'   ? 'ë§ˆìŠ¤í„° ë°ì´í„° ê´€ë¦¬' :
            tab === 'reports'  ? 'ë³´ê³ ì„œ / í˜„í™©' :
            tab === 'schedule' ? 'ì¼ì • / ê°„íŠ¸' : 'íƒ­';
          content.innerHTML = `<div class="p-8 text-center text-gray-500">${label} íƒ­ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. (ë°ì´í„° ì—°ë™ ë‹¨ê³„ì—ì„œ ë‚´ìš©ì´ ì±„ì›Œì§‘ë‹ˆë‹¤)</div>`;
        }
      });
    });
  });
</script>

<script>
/** ===== Sheets ì–´ëŒ‘í„°: ê¸°ì¡´ í•¨ìˆ˜ ì´ë¦„ ìœ ì§€(ë ˆì´ì•„ì›ƒ/ë””ìì¸ ë³€ê²½ ì—†ìŒ) ===== **/

// 1) ì›¹ì•± URL ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸°
//  - ì´ë¯¸ api ì…ë ¥ì¹¸ì´ ìˆëŠ” app.htmlì„ ì“°ì‹ ë‹¤ë©´, ê·¸ ì…ë ¥ì¹¸ì— ë¶™ì—¬ë„£ê³  LocalStorageì— ì €ì¥í•˜ë©´ ë©ë‹ˆë‹¤.
//  - ì—¬ê¸°ëŠ” ì•ˆì „ë¹µìœ¼ë¡œ LocalStorageì—ì„œ ì½ì–´ì˜µë‹ˆë‹¤.
function getApiBase_() {
  // app.htmlì—ì„œ ì €ì¥í–ˆë˜ í‚¤ë¥¼ ì¬ì‚¬ìš©í•˜ê±°ë‚˜, ì²« ì„¤ì • ì‹œ ì•„ë˜ì— ì§ì ‘ ë„£ì–´ë„ ë©ë‹ˆë‹¤.
  return localStorage.getItem('https://script.google.com/macros/s/AKfycbzaKNWodt-9RbMwaLJKu4RyBEm0lwcmJcjtWyGPXLdO-ZYPQxafrIttzw6bPWsbBFZX/exec') || ''; // ë¹„ì–´ìˆìœ¼ë©´ ë‚˜ì¤‘ì— ì•ŒëŸ¿ ë„ì›€
}

async function api_(action, payload) {
  const url = getApiBase_();
  if (!url) { alert('Apps Script ì›¹ì•± URLì„ ë¨¼ì € ì €ì¥í•˜ì„¸ìš”.'); throw new Error('No API URL'); }
  const res = await fetch(url, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ action, ...payload })
  });
  const text = await res.text();
  try { return JSON.parse(text); } catch(e) { return { error: 'Invalid JSON', raw: text }; }
}

// 2) ì‹œíŠ¸ í‚¤ ë§¤í•‘ (ê¸°ì¡´ COLLECTIONS ì´ë¦„ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
const SHEET_KEYS = {
  projects: 'projects',
  daily_logs: 'daily_logs',
  schedules: 'schedules',
  master_personnel: 'master_personnel',
  master_equipment: 'master_equipment',
  master_materials: 'master_materials',
  master_outsourcing: 'master_outsourcing',
  master_costItems: 'master_costItems',
};

// 3) ê¸°ì¡´ ì½”ë“œì—ì„œ ë¶€ë¥´ë˜ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë¥¼ "ì‹œíŠ¸ ì½ê¸°"ë¡œ ëŒ€ì²´
async function setupDataListeners() {
  // projects
  const projects = await api_('read', { sheet: SHEET_KEYS.projects });
  globalState.projects = Array.isArray(projects) ? projects : [];
  if (!globalState.selectedProjectId && globalState.projects.length) {
    globalState.selectedProjectId = globalState.projects[0].id || null;
  }

  // master data
  const types = ['personnel','equipment','materials','outsourcing','costItems'];
  for (const t of types) {
    const sheetKey = SHEET_KEYS['master_'+t];
    const rows = await api_('read', { sheet: sheetKey });
    globalState.masterData[t] = Array.isArray(rows) ? rows : [];
  }

  // daily logs (ì „ì²´ ì½ì–´ì„œ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°)
  const logs = await api_('read', { sheet: SHEET_KEYS.daily_logs });
  globalState.dailyLogs = Array.isArray(logs) ? logs : [];

  // schedules
  const sch = await api_('read', { sheet: SHEET_KEYS.schedules });
  globalState.schedules = Array.isArray(sch) ? sch : [];

  // ë Œë”
  renderApp();

  // ê°€ë²¼ìš´ í´ë§(ì„ íƒ): 15ì´ˆë§ˆë‹¤ ìƒˆë¡œê³ ì¹¨ ëŠë‚Œ
  if (!window.__sheets_polling__) {
    window.__sheets_polling__ = setInterval(setupDataListeners, 15000);
  }
}

// 4) ì €ì¥/ìˆ˜ì • (ê¸°ì¡´ saveDocument ëŒ€ì²´)
//   - id ì—†ìœ¼ë©´ create, ìˆìœ¼ë©´ update
async function saveDocument(collectionName, data, id) {
  try {
    const sheet = SHEET_KEYS[collectionName];
    if (!sheet) throw new Error('Unknown collection: ' + collectionName);

    if (id) {
      await api_('update', { sheet, id, record: data });
      showMessage('ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    } else {
      await api_('create', { sheet, record: data });
      showMessage('ì¶”ê°€ ì™„ë£Œ');
    }
    // ì €ì¥ í›„ ìµœì‹  ë°ì´í„° ë°˜ì˜
    await setupDataListeners();
  } catch (e) {
    console.error(e);
    showMessage('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + e.message, true);
  }
}

// 5) ì‚­ì œ (ê¸°ì¡´ deleteDocument ëŒ€ì²´)
async function deleteDocument(collectionName, id) {
  if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
  try {
    const sheet = SHEET_KEYS[collectionName];
    if (!sheet) throw new Error('Unknown collection: ' + collectionName);
    await api_('delete', { sheet, id });
    showMessage('ì‚­ì œ ì™„ë£Œ');
    await setupDataListeners();
  } catch (e) {
    console.error(e);
    showMessage('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + e.message, true);
  }
}

// 6) Firebase ì´ˆê¸°í™” ìë¦¬ì—, ê·¸ëƒ¥ UI ë³´ì´ê¸° + ë°ì´í„° ë¡œë“œ
async function initializeFirebase() {
  // ë¡œë”© ìˆ¨ê¸°ê³  ë³¸ë¬¸ ë³´ì´ê¸° (ê¸°ì¡´ êµ¬ì¡° ìœ ì§€)
  const loading = document.getElementById('loadingIndicator');
  const main = document.getElementById('mainContent');
  if (loading) loading.classList.add('hidden');
  if (main) main.classList.remove('hidden');

  // ì‚¬ìš©ì IDëŠ” Sheetsë¼ì„œ ì—†ìœ¼ë‹ˆ ê°„ë‹¨ ì•ˆë‚´
  const uid = document.getElementById('userIdDisplay');
  if (uid) uid.textContent = 'Sheets-Mode';

  // ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  await setupDataListeners();
}
</script>

  <script>
/* ===============================
   ğŸ§  Google Sheets Adapter
   =============================== */

const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzaKNWodt-9RbMwaLJKu4RyBEm0lwcmJcjtWyGPXLdO-ZYPQxafrIttzw6bPWsbBFZX/exec"; 
// ì˜ˆ: https://script.google.com/macros/s/AKfycbyA.../exec

async function sheetAPI(action, sheetName, data = {}) {
  try {
    const response = await fetch(SHEETS_WEBAPP_URL, {
      method: "POST",
      mode: "cors",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ action, sheetName, data })
    });
    return await response.json();
  } catch (error) {
    console.error("ì‹œíŠ¸ í†µì‹  ì˜¤ë¥˜:", error);
    alert("ë°ì´í„° í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (ì¸í„°ë„· ì—°ê²° ë˜ëŠ” ìŠ¤í¬ë¦½íŠ¸ URL í™•ì¸)");
  }
}

// ğŸŸ¢ ì˜ˆì‹œ ì‚¬ìš©ë²• (ê¸°ë³¸ CRUD)
async function loadProjects() {
  const result = await sheetAPI("read", "projects");
  console.log("ğŸ“‚ í”„ë¡œì íŠ¸ ëª©ë¡:", result);
}

async function addProject(name, budget, startDate, endDate) {
  const newProject = { name, budget, startDate, endDate };
  const result = await sheetAPI("create", "projects", newProject);
  console.log("âœ… ìƒˆ í”„ë¡œì íŠ¸ ì €ì¥:", result);
}

async function deleteProject(id) {
  const result = await sheetAPI("delete", "projects", { id });
  console.log("ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ:", result);
}
</script>

  
</body>
</html>
