
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Project Data Flow Hub – 주영건설산업</title>
  <link rel="icon" href="logo.svg" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Inter', sans-serif; background-color: #f7f9fb; }
    .tab-btn.active { background-color: #4f46e5 !important; color: #fff !important; }
    .modal-bg { position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; justify-content: center; align-items: center; z-index: 50; }
    .modal-box { background: white; padding: 20px; border-radius: 14px; width: 420px; max-width: 95%; }
  </style>
</head>
<body class="bg-gray-50">
  <header class="bg-white shadow">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <img src="logo.svg" alt="logo" class="w-7 h-7" />
        <h1 class="text-xl md:text-2xl font-extrabold text-indigo-700">Project Data Flow Hub</h1>
      </div>
      <a href="index.html" class="text-sm text-indigo-600 hover:underline">← 회사 메인으로</a>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <div class="bg-white p-4 rounded-xl shadow mb-4">
      <label class="block text-sm font-semibold text-gray-700">Apps Script 웹앱 URL</label>
      <input
        id="apiBase"
        type="text"
        placeholder="https://script.google.com/macros/s/AKfycb.../exec"
        class="w-full mt-1 p-2 border rounded"
      />
      <p class="text-xs text-gray-500 mt-1">
        * Google Apps Script에서 웹앱으로 배포한 뒤, 나온 URL을 여기 붙여넣고 <b>주소 저장</b>을 눌러 주세요.
      </p>
      <div class="mt-2 flex items-center space-x-2">
        <button id="saveApi" class="bg-indigo-600 text-white px-3 py-1 rounded">주소 저장</button>
        <span id="apiSaved" class="text-xs text-green-600"></span>
      </div>
    </div>

    <div class="grid grid-cols-2 md:grid-cols-6 gap-2 mb-4">
      <button class="tab-btn bg-indigo-600 text-white px-3 py-2 rounded" data-tab="projects">프로젝트</button>
      <button class="tab-btn bg-white border px-3 py-2 rounded" data-tab="personnel">인원</button>
      <button class="tab-btn bg-white border px-3 py-2 rounded" data-tab="materials">자재</button>
      <button class="tab-btn bg-white border px-3 py-2 rounded" data-tab="outsourcing">외주</button>
      <button class="tab-btn bg-white border px-3 py-2 rounded" data-tab="costs">비용</button>
      <button class="tab-btn bg-white border px-3 py-2 rounded" data-tab="schedules">일정</button>
    </div>

    <section id="view" class="bg-white rounded-xl shadow p-4"></section>
  </main>

  <template id="tableTemplate">
    <div>
      <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold" id="sheetTitle"></h2>
        <div class="space-x-2 flex items-center">
          <button id="exportExcelBtn" class="text-xs bg-emerald-500 text-white px-3 py-1 rounded border">
            엑셀 다운로드
          </button>
          <button id="exportPdfBtn" class="text-xs bg-slate-500 text-white px-3 py-1 rounded border">
            PDF 다운로드
          </button>
          <button id="reloadBtn" class="text-sm bg-gray-100 px-3 py-1 rounded border">새로고침</button>
          <button id="addBtn" class="text-sm bg-indigo-600 text-white px-3 py-1 rounded">새로 추가</button>
        </div>
      </div>

      <div id="costChartWrapper" class="mb-4 hidden">
        <canvas id="costChart" height="80"></canvas>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full text-sm" id="dataTable">
          <thead></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </template>

  <script>
    const SHEETS = {
      projects: {
        label: "프로젝트",
        sheetKey: "projects",
        headers: [
          "id","name","budget","startDate","endDate","owner","description",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      personnel: {
        label: "인원",
        sheetKey: "personnel",
        headers: [
          "id","name","role","unitCost","contact","memo",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      materials: {
        label: "자재",
        sheetKey: "materials",
        headers: [
          "id","name","spec","unit","unitPrice","supplier","memo",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      outsourcing: {
        label: "외주",
        sheetKey: "outsourcing",
        headers: [
          "id","company","serviceType","contractValue","period","manager","phone",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      costs: {
        label: "비용",
        sheetKey: "dailyLogs",
        headers: [
          "id","projectName","logDate","category","item","amount",
          "type","paidStatus","memo",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      schedules: {
        label: "일정",
        sheetKey: "schedules",
        headers: [
          "id","projectName","taskName","startDate","endDate","isCompleted","memo",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      extra1: {
        label: "여유시트1",
        sheetKey: "extra1",
        headers: [
          "id","col1","col2","col3","col4","col5",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      extra2: {
        label: "여유시트2",
        sheetKey: "extra2",
        headers: [
          "id","col1","col2","col3","col4","col5",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      extra3: {
        label: "여유시트3",
        sheetKey: "extra3",
        headers: [
          "id","col1","col2","col3","col4","col5",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
      extra4: {
        label: "여유시트4",
        sheetKey: "extra4",
        headers: [
          "id","col1","col2","col3","col4","col5",
          "extra1","extra2","extra3","extra4","extra5"
        ],
      },
    };

    const view = document.getElementById("view");
    const apiInput = document.getElementById("apiBase");
    const saveApiBtn = document.getElementById("saveApi");
    const apiSaved = document.getElementById("apiSaved");
    const tabButtons = document.querySelectorAll(".tab-btn");

    let currentTabKey = "projects";

    apiInput.value = localStorage.getItem("SHEETS_API_URL") || "";

    saveApiBtn.onclick = () => {
      const url = apiInput.value.trim();
      if (!url) {
        alert("웹앱 URL을 입력해 주세요.");
        return;
      }
      localStorage.setItem("SHEETS_API_URL", url);
      apiSaved.textContent = "저장됨";
      setTimeout(() => (apiSaved.textContent = ""), 1500);
    };

    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.dataset.tab;
        switchTab(tab);
      });
    });

    function switchTab(tabKey) {
      currentTabKey = tabKey;
      tabButtons.forEach((b) => {
        const isActive = b.dataset.tab === tabKey;
        b.classList.toggle("active", isActive);
        if (isActive) {
          b.classList.remove("bg-white", "border", "text-gray-800");
          b.classList.add("bg-indigo-600", "text-white");
        } else {
          b.classList.add("bg-white", "border", "text-gray-800");
        }
      });
      renderTable(tabKey);
    }

    function el(html) {
      const t = document.createElement("template");
      t.innerHTML = html.trim();
      return t.content.firstChild;
    }

    async function renderTable(tabKey) {
      const cfg = SHEETS[tabKey];
      const sheetKey = cfg.sheetKey;

      const tpl = document.getElementById("tableTemplate").content.cloneNode(true);
      const titleEl = tpl.getElementById("sheetTitle");
      const reloadBtn = tpl.getElementById("reloadBtn");
      const addBtn = tpl.getElementById("addBtn");
      const exportExcelBtn = tpl.getElementById("exportExcelBtn");
      const exportPdfBtn = tpl.getElementById("exportPdfBtn");
      const costChartWrapper = tpl.getElementById("costChartWrapper");

      titleEl.textContent = cfg.label;

      reloadBtn.onclick = () => renderTable(tabKey);
      addBtn.onclick = () => openEditor(tabKey, null);
      exportExcelBtn.onclick = () => exportSheetToExcel(tabKey);
      exportPdfBtn.onclick = () => exportSheetToPdf(tabKey);

      if (tabKey === "costs") {
        costChartWrapper.classList.remove("hidden");
      }

      const table = tpl.getElementById("dataTable");
      const thead = table.querySelector("thead");
      const tbody = table.querySelector("tbody");

      thead.innerHTML =
        "<tr>" +
        cfg.headers
          .map(
            (h) =>
              `<th class="text-left px-3 py-2 bg-gray-50 border-b text-xs font-semibold text-gray-600">${h}</th>`
          )
          .join("") +
        `<th class="px-3 py-2 bg-gray-50 border-b text-right text-xs font-semibold text-gray-600">액션</th></tr>`;

      const rows = await api("read", { sheet: sheetKey });
      const list = Array.isArray(rows) ? rows : [];

      tbody.innerHTML = "";

      list.forEach((obj) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";

        cfg.headers.forEach((h) => {
          const value = obj[h] ?? "";
          tr.appendChild(
            el(
              `<td class="px-3 py-1 border-t align-middle">${String(
                value
              )}</td>`
            )
          );
        });

        const actTd = el(
          `<td class="px-3 py-1 border-t text-right align-middle space-x-2"></td>`
        );
        const editBtn = el(
          `<button class="text-xs px-2 py-1 bg-gray-100 rounded border">수정</button>`
        );
        const delBtn = el(
          `<button class="text-xs px-2 py-1 bg-red-600 text-white rounded">삭제</button>`
        );

        editBtn.onclick = () => openEditor(tabKey, obj);
        delBtn.onclick = async () => {
          if (confirm("삭제하시겠습니까?")) {
            await api("delete", { sheet: sheetKey, id: obj.id });
            renderTable(tabKey);
          }
        };

        actTd.append(editBtn, delBtn);
        tr.appendChild(actTd);
        tbody.appendChild(tr);
      });

      if (tabKey === "costs") {
        drawCostChart(list);
      }

      view.innerHTML = "";
      view.appendChild(tpl);
    }

    function openEditor(tabKey, existing) {
      const cfg = SHEETS[tabKey];
      const headers = cfg.headers;

      const bg = el(`<div class="modal-bg"></div>`);
      const box = el(`<div class="modal-box"></div>`);
      const title = existing ? "항목 수정" : "새 항목 추가";

      const h3 = el(
        `<h3 class="text-lg font-bold mb-3">${title} – ${cfg.label}</h3>`
      );

      const form = document.createElement("form");
      form.className = "grid grid-cols-1 md:grid-cols-2 gap-3";

      headers.forEach((h) => {
        if (h === "id") {
          const idVal = existing ? existing.id || "" : "";
          const wrap = el(
            `<div class="md:col-span-2 hidden">
              <label class="text-xs text-gray-500">id</label>
              <input class="w-full border rounded px-2 py-1 mt-1" name="id" value="${idVal}">
             </div>`
          );
          form.appendChild(wrap);
          return;
        }

        const val = existing ? existing[h] ?? "" : "";

        let inputHtml;
        if (h.toLowerCase().includes("description") || h === "memo") {
          inputHtml = `
            <div class="md:col-span-2">
              <label class="text-xs text-gray-500">${h}</label>
              <textarea class="w-full border rounded px-2 py-1 mt-1" name="${h}" rows="3">${val}</textarea>
            </div>`;
        } else if (h.toLowerCase().includes("date")) {
          inputHtml = `
            <div>
              <label class="text-xs text-gray-500">${h}</label>
              <input type="date" class="w-full border rounded px-2 py-1 mt-1" name="${h}" value="${val}">
            </div>`;
        } else if (
          h.toLowerCase().includes("amount") ||
          h.toLowerCase().includes("value") ||
          h.toLowerCase().includes("price") ||
          h.toLowerCase().includes("budget") ||
          h.toLowerCase().includes("cost")
        ) {
          inputHtml = `
            <div>
              <label class="text-xs text-gray-500">${h}</label>
              <input type="number" step="0.01" class="w-full border rounded px-2 py-1 mt-1" name="${h}" value="${val}">
            </div>`;
        } else if (h === "type") {
          inputHtml = `
            <div>
              <label class="text-xs text-gray-500">type (expense/income)</label>
              <select class="w-full border rounded px-2 py-1 mt-1" name="type">
                <option value="">선택</option>
                <option value="expense" ${val === "expense" ? "selected" : ""}>expense (비용)</option>
                <option value="income" ${val === "income" ? "selected" : ""}>income (수입)</option>
              </select>
            </div>`;
        } else if (h === "paidStatus") {
          inputHtml = `
            <div>
              <label class="text-xs text-gray-500">지급상태</label>
              <select class="w-full border rounded px-2 py-1 mt-1" name="paidStatus">
                <option value="">선택</option>
                <option value="미지급" ${val === "미지급" ? "selected" : ""}>미지급</option>
                <option value="지급완료" ${val === "지급완료" ? "selected" : ""}>지급완료</option>
              </select>
            </div>`;
        } else if (h === "isCompleted") {
          const checked = String(val) === "true" || val === true ? "checked" : "";
          inputHtml = `
            <div>
              <label class="text-xs text-gray-500">완료 여부</label>
              <div class="mt-1 flex items-center space-x-2">
                <input type="checkbox" name="isCompleted" ${checked} class="h-4 w-4">
                <span class="text-xs text-gray-600">완료</span>
              </div>
            </div>`;
        } else {
          inputHtml = `
            <div>
              <label class="text-xs text-gray-500">${h}</label>
              <input class="w-full border rounded px-2 py-1 mt-1" name="${h}" value="${val}">
            </div>`;
        }

        form.appendChild(el(inputHtml));
      });

      const btnWrap = el(
        `<div class="md:col-span-2 flex justify-end space-x-2 mt-2"></div>`
      );
      const saveBtn = el(
        `<button class="bg-indigo-600 text-white px-3 py-1 rounded" type="submit">저장</button>`
      );
      const cancelBtn = el(
        `<button class="bg-gray-100 px-3 py-1 rounded border" type="button">취소</button>`
      );

      cancelBtn.onclick = () => bg.remove();
      btnWrap.append(saveBtn, cancelBtn);
      form.appendChild(btnWrap);

      form.onsubmit = async (e) => {
        e.preventDefault();
        const fd = new FormData(form);
        const record = {};
        headers.forEach((h) => {
          if (h === "id") return;
          if (h === "isCompleted") {
            record[h] = fd.get("isCompleted") ? true : false;
          } else {
            record[h] = fd.get(h) ?? "";
          }
        });
        const idVal = fd.get("id") || (existing && existing.id) || "";

        const payload = idVal
          ? { sheet: cfg.sheetKey, id: idVal, record }
          : { sheet: cfg.sheetKey, record };

        await api(idVal ? "update" : "create", payload);
        bg.remove();
        renderTable(tabKey);
      };

      box.appendChild(h3);
      box.appendChild(form);
      bg.appendChild(box);
      document.body.appendChild(bg);
    }

    async function api(action, payload) {
      const url = localStorage.getItem("SHEETS_API_URL") || apiInput.value.trim();
      if (!url) {
        alert("먼저 Apps Script 웹앱 URL을 입력/저장하세요.");
        throw new Error("No API URL");
      }

      const body = JSON.stringify({ action, ...payload });

      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body,
      });

      const text = await res.text();
      try {
        return JSON.parse(text);
      } catch (e) {
        console.error("API 응답 JSON 파싱 실패:", text);
        return [];
      }
    }

    async function exportSheetToExcel(tabKey) {
      const cfg = SHEETS[tabKey];
      const rows = await api("read", { sheet: cfg.sheetKey });
      const list = Array.isArray(rows) ? rows : [];

      const data = [cfg.headers];
      list.forEach((obj) => {
        data.push(cfg.headers.map((h) => obj[h] ?? ""));
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, cfg.label);
      XLSX.writeFile(wb, `export_${cfg.sheetKey}.xlsx`);
    }

    async function exportSheetToPdf(tabKey) {
      const cfg = SHEETS[tabKey];
      const rows = await api("read", { sheet: cfg.sheetKey });
      const list = Array.isArray(rows) ? rows : [];

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ orientation: "landscape" });

      doc.setFontSize(14);
      doc.text(`Sheet: ${cfg.label}`, 14, 16);
      doc.setFontSize(8);

      let y = 24;
      const lineHeight = 5;

      doc.text(cfg.headers.join(" | "), 10, y);
      y += lineHeight;

      list.forEach((obj, idx) => {
        const rowText = cfg.headers.map((h) => String(obj[h] ?? "")).join(" | ");
        doc.text(rowText, 10, y);
        y += lineHeight;
        if (y > 190 && idx < list.length - 1) {
          doc.addPage();
          y = 20;
        }
      });

      doc.save(`export_${cfg.sheetKey}.pdf`);
    }

    let costChartInstance = null;

    function drawCostChart(list) {
      const ctx = document.getElementById("costChart");
      if (!ctx) return;

      const byDate = {};
      list.forEach((row) => {
        const date = row.logDate || row.date || "";
        if (!date) return;
        const amount = Number(row.amount || 0);
        if (!byDate[date]) byDate[date] = 0;
        if (row.type === "income") {
          byDate[date] -= amount;
        } else {
          byDate[date] += amount;
        }
      });

      const labels = Object.keys(byDate).sort();
      const values = labels.map((d) => byDate[d]);

      if (costChartInstance) {
        costChartInstance.destroy();
      }

      costChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "일자별 순비용(수입-비용)",
              data: values,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
          },
          scales: {
            x: { ticks: { font: { size: 9 } } },
            y: { ticks: { font: { size: 9 } } },
          },
        },
      });
    }

    window.addEventListener("load", () => {
      switchTab("projects");
    });
  </script>
</body>
</html>
